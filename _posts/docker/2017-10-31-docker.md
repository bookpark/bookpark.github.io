---
layout: post
comments: true
title: "Docker란 무엇인가"
categories: Docker
---

서버 관리를 하기 위한 Docker에 대해 알아보고 설정하는 법을 정리해보았다.

[초보를 위한 도커 안내서](https://subicura.com/2017/01/19/docker-guide-for-beginners-1.html)

---

Request >> Computer >> Ubuntu (in docker) >> Nginx >> uWSGI >> Django



### Dockerfile 설정

- instagram_project/Dockerfile.base — *Dockerfile의 base가 될 dockerfile을 생성해준다*

```dockerfile
FROM        ubuntu:16.04
MAINTAINER  <email_address>

RUN         apt-get -y update
RUN         apt-get -y dist-upgrade
RUN         apt-get install -y python-pip git vim

# pyenv
RUN         apt-get install -y make build-essential libssl-dev zlib1g-dev libbz2-dev \
libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
xz-utils tk-dev

RUN         curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash
ENV         PATH /root/.pyenv/bin:$PATH
RUN         pyenv install 3.6.2

# zsh
RUN         apt-get install -y zsh
RUN         wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | zsh || true
RUN         chsh -s /usr/bin/zsh

# pyenv settings
RUN         echo 'export PATH="/root/.pyenv/bin:$PATH"' >> ~/.zshrc
RUN         echo 'eval "$(pyenv init -)"' >> ~/.zshrc
RUN         echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.zshrc

# pyenv virtualenv
RUN         pyenv virtualenv 3.6.2 app

# uWGSI install
RUN         /root/.pyenv/versions/app/bin/pip install uwsgi

# Nginx install
RUN         apt-get -y install nginx

# supervisor install
RUN         apt-get -y install supervisor

# pip
ENV         LANG C.UTF-8
COPY        requirements.txt /srv/requirements.txt
RUN         /root/.pyenv/versions/app/bin/pip install -r /srv/requirements.txt
```

- project_folder/

```bash
>>> docker build -t base -f Dockerfile.base .
```

- instagram_project/Dockerfile — *Dockerfile을 생성해준다* 
  - Elastic Beanstalk으로 deploy 할 때 필요한 Dockerfile이다.
  - 이 Dockerfile은 언제든 변경 될 수 있으며,
  - 개발 환경으로 Docker를 실행하고 싶다면 아래에 나오는 Dockerfile.dev >> Dockerfile로 이름을 변경 후,
  - `eb deploy` 를 실행 해 deploy를 할 수 있다.

```dockerfile
FROM        base
MAINTAINER  <email-address>

ENV         LANG C.UTF-8

COPY        . /srv/app
RUN         /root/.pyenv/versions/app/bin/pip install -r /srv/app/requirements.txt
```

```bash
>>> docker build -t eb .
```

- Docker 실행

```bash
docker run --rm -it eb /bin/zsh
```

- Docker 포트 지정 접근

```bash
docker run --rm -it -p 8012:80 -p 8013:8000 eb /bin/zsh
```

> 8012 포트는 80번 포트로 8013 포트는 localhost 8000 포트로 연결 후 실행



### Docker 명령어

- 현재 위치를 기준으로 Dockerfile을 이용해 새 이미지 생성

``` bash
docker build . -t [이미지이름(태그명)]
```

- 현재 위치를 기준으로 특정 파일을 이용해 새 이미지 생성

```
docker build . -t [이미지태그명] -f [파일명]
```

- 이미지를 컨테이너로 실행하며 셸로 이동

```bash
docker run --rm -it [이미지명] /bin/zsh
```

- 이미지로 컨테이너를 실행하며 포트 연결

```bash
docker run --rm -it -p <외부포트>:<컨테이너포트> <이미지명> <실행할 명령>
```

- 실행중인 컨테이너에 명령 실행

```bash
docker exec [container id] [실행할 명령]
```

- 실행중인 컨테이너에 접속 후 셸 실행하고 싶을 경우

```
docker exec -it [container id] /bin/zsh
```

- Delete all docker containers

```bash
docker rm $(docker ps -a -q)
```

- Delete all docker images

```bash
docker rmi $(docker images -q)
```

- Docker <none> 이미지 파일 삭제

```bash
docker rmi -f $(docker images --filter "dangling=true" -q)
# 또는
docker rmi $(docker images -a | grep "<none>" | awk '{print $3}')
```



### Docker 분리

- Dockerfile.local — *Local 환경에서 쓰일 수 있도록 Nginx와 superviser 경로 변경*

```dockerfile
FROM        <username>/base
MAINTAINER  <email_address>

ENV         LANG C.UTF-8

# 파일 복사 및 requirements 설치
COPY        . /srv/app
RUN         /root/.pyenv/versions/app/bin/pip install -r /srv/app/requirements.txt

# pyenv local 설정
WORKDIR     /srv/app
RUN         pyenv local app

# Nginx
RUN         cp /srv/app/.config/local/nginx/nginx.conf \
                /etc/nginx/nginx.conf
RUN         cp /srv/app/.config/local/nginx/app.conf \
                /etc/nginx/sites-available/
RUN         rm -rf /etc/nginx/sites-enabled/*
RUN         ln -sf /etc/nginx/sites-available/app.conf \
                    /etc/nginx/sites-enabled/app.conf

# uWSGI (-p는 디렉토리가 없으면 순서대로 생성 명령)
RUN         mkdir -p /var/log/uwsgi/app

# manage.py
WORKDIR     /srv/app/instagram
RUN         /root/.pyenv/versions/app/bin/python manage.py collectstatic --noinput
RUN         /root/.pyenv/versions/app/bin/python manage.py migrate --noinput

# supervisor
RUN         cp /srv/app/.config/local/supervisor/* \
                /etc/supervisor/conf.d/
CMD         supervisord -n

EXPOSE      80
```

- Dockerfile.dev — *Dev 환경에서 쓰일 수 있도록 경로 변경 및 DJANGO_SETTINGS_MODULE 설정*

```dockerfile
FROM        bookpark/base
MAINTAINER  bkbkgg@gmail.com

ENV         LANG C.UTF-8
ENV         DJANGO_SETTINGS_MODULE config.settings.dev

# 파일 복사 및 requirements 설치
COPY        . /srv/app
RUN         /root/.pyenv/versions/app/bin/pip install -r /srv/app/requirements.txt

# pyenv local 설정
WORKDIR     /srv/app
RUN         pyenv local app

# Nginx
RUN         cp /srv/app/.config/dev/nginx/nginx.conf \
                /etc/nginx/nginx.conf
RUN         cp /srv/app/.config/dev/nginx/app.conf \
                /etc/nginx/sites-available/
RUN         rm -rf /etc/nginx/sites-enabled/*
RUN         ln -sf /etc/nginx/sites-available/app.conf \
                    /etc/nginx/sites-enabled/app.conf

# uWSGI (-p는 디렉토리가 없으면 순서대로 생성 명령)
RUN         mkdir -p /var/log/uwsgi/app

# manage.py
WORKDIR     /srv/app/instagram
RUN         /root/.pyenv/versions/app/bin/python manage.py collectstatic --noinput
RUN         /root/.pyenv/versions/app/bin/python manage.py migrate --noinput

# supervisor
RUN         cp /srv/app/.config/dev/supervisor/* \
                /etc/supervisor/conf.d/
CMD         supervisord -n

EXPOSE      80
```



