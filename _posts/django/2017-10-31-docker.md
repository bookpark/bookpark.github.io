---
layout: post
comments: true
title: "Docker란 무엇인가"
categories: Docker
---

서버 관리를 하기 위한 Docker에 대해 알아보고 설정하는 법을 정리해보았다.

---

Request >> Computer >> Ubuntu (in docker) >> Nginx >> uWSGI >> Django



### Dockerfile 설정

- instagram_project/Dockerfile.base — *Dockerfile의 base가 될 dockerfile을 생성해준다*

```dockerfile
FROM        ubuntu:16.04
MAINTAINER  <email-address>

RUN         apt-get -y update
RUN         apt-get -y dist-upgrade
RUN         apt-get install -y python-pip git vim

# pyenv
RUN         apt-get install -y make build-essential libssl-dev zlib1g-dev libbz2-dev \
libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
xz-utils tk-dev

RUN         curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash
ENV         PATH /root/.pyenv/bin:$PATH
RUN         pyenv install 3.6.2

# zsh
RUN         apt-get install -y zsh
RUN         wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | zsh || true
RUN         chsh -s /usr/bin/zsh

# pyenv settings
RUN         echo 'export PATH="/root/.pyenv/bin:$PATH"' >> ~/.zshrc
RUN         echo 'eval "$(pyenv init -)"' >> ~/.zshrc
RUN         echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.zshrc

# pyenv virtualenv
RUN         pyenv virtualenv 3.6.2 app

# uWGSI install
RUN         /root/.pyenv/versions/app/bin/pip install uwsgi

# Nginx install
RUN         apt-get -y install nginx

# supervisor install
RUN         apt-get -y install supervisor
```

```bash
>>> docker build -t base -f Dockerfile.base .
```

- instagram_project/Dockerfile — *Dockerfile을 생성해준다*

```dockerfile
FROM        base
MAINTAINER  <email-address>

ENV         LAN C.UTF-8

COPY        . /srv/app
RUN         /root/.pyenv/versions/app/bin/pip install -r /srv/app/requirements.txt
```

```bash
>>> docker build -t eb .
```

- Docker 실행

```bash
docker run --rm -it eb /bin/zsh
```

- Docker 포트 지정 접근

```bash
docker run --rm -it -p 8012:80 -p 8013:8000 eb /bin/zsh
```

> Docker를 두개 돌릴 시에는 위 처럼 포트를 두개를 주고 하나만 돌릴 시에는 한개 할당



### Docker 명령어

- 현재 위치를 기준으로 Dockerfile을 이용해 새 이미지 생성

``` bash
docker build . -t [이미지이름(태그명)]
```

- 현재 위치를 기준으로 특정 파일을 이용해 새 이미지 생성

```
docker build . -t [이미지태그명] -f [파일명]
```

- 이미지를 컨테이너로 실행하며 셸로 이동

```bash
docker run --rm -it [이미지명] /bin/zsh
```

- 이미지로 컨테이너를 실행하며 포트 연결

```bash
docker run --rm -it -p <외부포트>:<컨테이너포트> <이미지명> <실행할 명령>
```

- 실행중인 컨테이너에 명령 실행

```bash
docker exec [container id] [실행할 명령]
```

- 실행중인 컨테이너에 접속 후 셸 실행하고 싶을 경우

```
docker exec -it [container id] /bin/zsh
```

- Delete all docker containers

```bash
docker rm $(docker ps -a -q)
```

- Delete all docker images

```bash
docker rmi $(docker images -q)
```

- Docker <none> 이미지 파일 삭제

```bash
docker rmi -f $(docker images --filter "dangling=true" -q)
# 또는
docker rmi $(docker images -a | grep "<none>" | awk '{print $3}')
```



### WSGI 모듈화

기본 config 안에 있는 wsgi.py를 local, dev 환경에서 각각 다르게 동작하도록 모듈화 한다. 

- config/wsgi/_\_init__.py

```python
from .local import *
```

- config/wsgi/local.py

```python
import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings.local")

application = get_wsgi_application()
```

- config/wsgi/dev.py

```python
import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings.dev")

application = get_wsgi_application()
```

