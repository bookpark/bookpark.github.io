---
layout: post
comments: true
title: "AWS 배포"
categories: AWS
---

이번 포스트에서는 AWS를 통한 서버 배포 방법을 배워봅니다.

---

### User 생성 (IAM)

-   Access type
    -   Programmatic access
        -   for the AWS API, CLI, SDK, and other development tools
    -   AWS Management Console access
        -   allows users to sign-in to the AWS Management Console
-   Set permission
    -   EC2 Full Access
-   credentials.csv

### Amazon EC2란?

-   Amazon Elastic Compute Cloud
    -   확장식 컴퓨팅 제공
-   AWS 프리 티어 (1년 무료)

### EC2 Dashboard

-   EC2 대시보드에서 키 페어 생성
-   다운로드 된 키는 안전하게 보관

### 인스턴스 생성

-   Ubuntu 16.04 사용

-   보안 그룹 구성

    -   보안 그룹 안에 EC2가 포함 되도록

-   키 페어 선택 또는 새 키 페어 생성

-   인스턴스 시작

-   퍼블릭 DNS 주소가 공개된 주소

    -   ssh를 사용해 인스턴스 접속

        -   .pem 프라이빗 키 찾기

        -   프라이빗 키 권한 변경 (400으로 변경)

            ```bash
            >>> chmod 400 <filename>
            ```

>   파일 권한 관련

```
_/rwx/rwx/rwx
- 파일 타입 / 소유주 / 그룹 / 아무나
- 읽기 / 쓰기 / 실행
```

>   접근

```bash
>>> ssh -i <keypair_path> ubuntu@<public_dns_address>
```

### AWS CLI

**설치**

```bash
>>> pip install awscli
```

**설정**

```bash
>>> aws configure
```

### 프로젝트 로컬 파일 전송

-   Django 애플리케이션은 /srv 디렉토리 사용

```bash
>>> sudo chown -R ubuntu:ubuntu /srv/
```

-   Secure copy를 통한 전송

```bash
>>> scp -i <key_pair_path> -r <project_directory> ubuntu@<public_dns>:/srv
```

### Runserver

```python
>>> ./manage.py runserver 0:8080
```

*   Runserver를 한 후 주소창에 Public DNS 주소:8080 을 입력해도 접속이 되지 않는다.
*   AWS Dashboard 보안그룹에서 편집을 클릭하고 인바운드에 8080 포트를 추가해준다.
*   다시 접속해보면 Django DisallowedHost 에러가 뜬다.
*   이럴 땐 `settings.py` ALLOWED_HOSTS에 주소를 추가해준다.

```python
ALLOWED_HOSTS = [
    'localhost',
    '.ap-northeast-2.compute.amazonaws.com',
]
```

*   이제 해당 포트로 접속을 하면 잘 뜨는 것을 확인할 수 있다.

### uWSGI 관련 설정

-   웹 서버 관리 유저 생성

```bash
>>> sudo adduser deploy
```

-   uWSGI 설치 (가상 환경을 새로 생성 후 설치한다)

```python
>>> pyenv shell uwsgi-env
>>> (uwsgi-env) pip install uwsgi
```

-   uWSGI 정상 작동 확인

```bash
>>> /home/ubuntu/.pyenv/versions/uwsgi-env/bin/uwsgi \
>>> --http :8080 \
>>> --home /home/ubuntu/.pyenv/versions/fc-ec2-deploy \
>>> --chdir /srv/ec2_deploy_project/mysite \
>>> -w config.wsgi
```



*서버 동작 플로*

>   *AWS - 웹서버 - WSGI - Django application*